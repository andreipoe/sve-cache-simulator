# SVE Cache Simulator

[![pipeline status](https://gitlab.com/phd-repos/sve-cache-simulator/badges/master/pipeline.svg)](https://gitlab.com/phd-repos/sve-cache-simulator/-/commits/master)


## Build

### Using Make

```bash
make COMPILER=...
```

Compilers available: `ARM`, `CLANG` (default), `CRAY`, `GNU`, `INTEL`.

You can specify additional options by setting `ARCH`, `CXX_<compiler>`, `CXXFLAGS_<compiler>`, and `LDFLAGS_<compiler>`.

### Using Meson

Requirements:

* [Meson](https://mesonbuild.com/Quick-guide.html) (`pip3 install --user meson`)
* Ninja

The default configuration builds with optimisations enabled:

```bash
env CXX=g++ meson build-gnu
cd build-gnu
ninja
```

The single `ninja` invocation builds both the main executable and the tests wrapper, placing both in the build directory.

To build a debug (`-Og -g3`) build:

```bash
env CXX=g++ meson --buildtype=debug build-debug-gnu
cd build-gnu
ninja
```

Only GNU and Clang have been tested, but Arm and Intel, and possibly Cray, should also work.
On MacOS 10.14, there is an issue with the default linker command when using LLVM, which can be worked around by setting the linker version argument:

```bash
env CXX=clang++ LDFLAGS='-mlinker-version=450.3 -v' meson build-clang
```

### Compatibility

On MacOS 10.14, not even Homebrew's LLVM's libc++ 10 accepts C++17 filesystem, so the tests can't be built; GCC 9 works fine.
You can force using libstdc++ instead, for which the version shipped with GCC 9 works:

```bash
env CXX=clang++ CXXFLAGS='-stdlib=libstdc++ -I/usr/local/opt/gcc/include/c++/9.3.0 -I/usr/local/opt/gcc/include/c++/9.3.0/x86_64-apple-darwin18 -Wno-stdlibcxx-not-found' LDFLAGS='-L/usr/local/opt/gcc/lib/gcc/9 -mlinker-version=450.3' meson build-clang
```

## Run

```bash
./scs -c config.ini trace.log
```

The simulator support both text-encoded trace files and raw binary dumps.
By default, the simulator will try to guess the encoding, but it's recommended you specify it manually:

```bash
./scs -c config.ini --text trace.log
./scs -c config.ini --binary trace.bin
```

A tool is provided to convert from text to binary traces:

```bash
./convert-trace -h
```

Reading binary traces is [about 5x faster](https://gitlab.com/phd-repos/sve-cache-simulator/-/issues/8#note_358269256) than parsing numbers from text.

### Tests

Tests are implemented using Catch2, and the tests executable is the one generated by the library.

```bash
./scs-test
```

## Configuration files

Cache configurations are read from ini files.
Some examples are provided in the `configs` folder.

### Defining a single cache

To define a single cache, don't use any sections in the ini file and define the parameters directly:

```ini
type = set_associative
cache_size = 32768
line_size = 64
set_size = 4
```

Alternatively, define it as a hierarchy with a single level:

```ini
[hierarchy]
levels = 1

[L1]
type = set_associative
cache_size = 32768
line_size = 64
set_size = 4
```

### Defining a cache hierarchy

To define a hierarchy, first define the number of levels, then define the parameters for each level in a separate section named `level<level-numer>`:

```ini
[hierarchy]
levels = 2

[L1]
type = set_associative
cache_size = 4096
line_size = 64
set_size = 4

[L2]
type = set_associative
cache_size = 32768
line_size = 64
set_size = 4
```
